<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìã NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Poppins',sans-serif; background:#f4f6f9; padding:20px; max-width:800px; margin:auto; }
    h2 { color:#4b2aad; }
    label { font-weight:600; margin-top:10px; display:block; }
    input, select, textarea {
      width:100%; padding:10px; margin:5px 0 15px;
      border:1px solid #ccc; border-radius:5px; font-size:16px;
    }
    .paid { background:#d4edda; color:#155724; font-weight:bold; }
    .not-paid { background:#f8d7da; color:#721c24; font-weight:bold; }
    button {
      background:#4b2aad; color:#fff; padding:12px 20px;
      border:none; border-radius:5px; font-size:16px; margin:5px;
      cursor:pointer;
    }
    button:hover { background:#3a208b; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    th { background:#4b2aad; color:white; }
  </style>
</head>
<body>

<h2>üìù NST Trip Sheet</h2>

<label>Trip ID</label>
<input id="tripId" readonly>

<label>Date</label>
<div style="position:relative">
  <input type="text" id="tripDateDisplay" placeholder="Select Date" readonly style="cursor:pointer">
  <input type="date" id="tripDate" style="opacity:0;position:absolute;top:0;left:0;width:100%;height:100%;">
</div>

<label>Duty</label>
<select id="dutyDropdown"></select>

<label>Pickup Location</label><input id="pickupLocation">
<label>Drop Location</label><input id="dropLocation">

<label>Customer Name</label><input id="custName">
<label>Customer Number</label><input id="custNumber">

<label>Driver Name</label><select id="driverName" onchange="syncDriver(true)"></select>
<label>Driver Number</label><select id="driverNumber" onchange="syncDriver(false)"></select>

<label>Vehicle Model</label><select id="vehicleModel" onchange="syncVehicle(true)"></select>
<label>Vehicle Number</label><select id="vehicleNo" onchange="syncVehicle(false)"></select>

<label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
<label>End Time</label><input type="time" id="endTime" onchange="recalc()">
<label>Total Duration (hrs)</label><input id="duration">

<label>Extra Hours</label><input id="extraHours">

<label>Start KM</label><input id="startKM" onchange="recalc()">
<label>End KM</label><input id="endKM" onchange="recalc()">
<label>Total KM</label><input id="totalKM">

<label>Extra KM</label><input id="extraKM">

<label>Parking ‚Çπ</label><input id="parking">
<label>Toll ‚Çπ</label><input id="toll">

<label>Total Amount ‚Çπ</label><input id="totalAmount">

<label>Payment Status</label>
<select id="paymentStatus" onchange="setPaymentStyle(this)">
  <option value="">-- Select --</option>
  <option value="Paid">Paid</option>
  <option value="Not Paid">Not Paid</option>
</select>

<label>Note</label><textarea id="note" rows="3"></textarea>

<div style="display:flex; flex-wrap:wrap; gap:10px;">
  <button onclick="shareWhatsApp()">üì§ Share via WhatsApp</button>
  <button onclick="showSharedTrips()">üìã View Saved Trips</button>
  <button onclick="location.href='admin.html'">üîê Admin Panel</button>
</div>

<div id="sharedTripsList"></div>

<script>
  let drivers = {}, vehicles = {};
  const SHKEY = "shared-trips";

  function init() {
    loadDropdown("duty-master", dutyDropdown, "name");

    const dList = JSON.parse(localStorage.getItem("driver-master") || "[]");
    driverName.innerHTML = driverNumber.innerHTML = '<option value="">-- Select --</option>';
    dList.forEach(d => {
      drivers[d.name] = d.mobile;
      driverName.innerHTML += `<option>${d.name}</option>`;
      driverNumber.innerHTML += `<option>${d.mobile}</option>`;
    });

    const vList = JSON.parse(localStorage.getItem("vehicle-master") || "[]");
    vehicleModel.innerHTML = vehicleNo.innerHTML = '<option value="">-- Select --</option>';
    vList.forEach(v => {
      vehicles[v.model] = v.number;
      vehicleModel.innerHTML += `<option>${v.model}</option>`;
      vehicleNo.innerHTML += `<option>${v.number}</option>`;
    });

    tripId.value = genId();
  }

  function loadDropdown(key, el, labelKey) {
    const list = JSON.parse(localStorage.getItem(key) || "[]");
    el.innerHTML = '<option value="">-- Select --</option>';
    list.forEach(item => {
      el.innerHTML += `<option>${item[labelKey]}</option>`;
    });
  }

  function genId() {
    let n = parseInt(localStorage.getItem("trip-seq") || "1");
    return "#NST" + String(n).padStart(3, "0");
  }

  function reserveId() {
    let n = parseInt(localStorage.getItem("trip-seq") || "1");
    localStorage.setItem("trip-seq", n + 1);
  }

  function syncDriver(fromName) {
    if (fromName) driverNumber.value = drivers[driverName.value] || "";
    else for (let k in drivers) if (drivers[k] === driverNumber.value) driverName.value = k;
  }

  function syncVehicle(fromModel) {
    if (fromModel) vehicleNo.value = vehicles[vehicleModel.value] || "";
    else for (let k in vehicles) if (vehicles[k] === vehicleNo.value) vehicleModel.value = k;
  }

  function recalc() {
    if (startTime.value && endTime.value) {
      let s = new Date(`2000-01-01T${startTime.value}`);
      let e = new Date(`2000-01-01T${endTime.value}`);
      let mins = (e - s) / 60000;
      if (mins < 0) mins += 1440;
      duration.value = (mins / 60).toFixed(2);
    }
    if (startKM.value && endKM.value)
      totalKM.value = (endKM.value - startKM.value);
  }

  function setPaymentStyle(el) {
    el.className = el.value === "Paid" ? "paid" : el.value === "Not Paid" ? "not-paid" : "";
  }

  function shareWhatsApp() {
    const msgParts = [
      `üìã *NST TRIP SUMMARY*`,
      `üóìÔ∏è *Trip ID:* ${tripId.value}`,
      tripDateDisplay.value ? `*Date:* ${tripDateDisplay.value}` : ``,
      pickupLocation.value ? `üìç *Pickup:* ${pickupLocation.value}` : ``,
      dropLocation.value ? `üìç *Drop:* ${dropLocation.value}` : ``,
      custName.value ? `üë§ *Customer:* ${custName.value} (${custNumber.value})` : ``,
      driverName.value ? `üë®‚Äç‚úàÔ∏è *Driver:* ${driverName.value} (${driverNumber.value})` : ``,
      vehicleModel.value ? `üöò *Vehicle:* ${vehicleModel.value} (${vehicleNo.value})` : ``,
      (startTime.value || endTime.value) ? `üïí *Time:* ${startTime.value || "-"} - ${endTime.value || "-"} (${duration.value || "-"} hrs)` : ``,
      extraHours.value ? `‚Ä¢ *Extra Hours:* ${extraHours.value}` : ``,
      (startKM.value || endKM.value) ? `üìè *KM:* ${startKM.value || "-"} - ${endKM.value || "-"} = ${totalKM.value || "-"} km` : ``,
      extraKM.value ? `‚Ä¢ *Extra KM:* ${extraKM.value}` : ``,
      parking.value || toll.value ? `üí∞ *Charges:* Toll ‚Çπ${toll.value || 0}, Parking ‚Çπ${parking.value || 0}` : ``,
      totalAmount.value ? `üí∞ *Total:* ‚Çπ${totalAmount.value}` : ``,
      paymentStatus.value ? `üí≥ *Payment:* ${paymentStatus.value}` : ``,
      note.value ? `üìù *Note:* ${note.value}` : ``
    ];
    const msg = msgParts.filter(x => x).join("\n");
    window.open("https://wa.me/?text=" + encodeURIComponent(msg), '_blank');

    saveTrip(); // save on share
  }

  function saveTrip() {
    const trip = {
      id: tripId.value,
      date: tripDateDisplay.value,
      duty: dutyDropdown.value,
      pickup: pickupLocation.value,
      drop: dropLocation.value,
      custName: custName.value,
      custNumber: custNumber.value,
      driverName: driverName.value,
      driverNumber: driverNumber.value,
      vehicleModel: vehicleModel.value,
      vehicleNo: vehicleNo.value,
      start: startTime.value,
      end: endTime.value,
      duration: duration.value,
      extraHours: extraHours.value,
      startKM: startKM.value,
      endKM: endKM.value,
      totalKM: totalKM.value,
      extraKM: extraKM.value,
      parking: parking.value,
      toll: toll.value,
      totalAmount: totalAmount.value,
      paymentStatus: paymentStatus.value,
      note: note.value
    };
    let trips = JSON.parse(localStorage.getItem(SHKEY) || "[]");
    trips.push(trip);
    localStorage.setItem(SHKEY, JSON.stringify(trips));
    reserveId();
    tripId.value = genId();
  }

  function showSharedTrips() {
    const trips = JSON.parse(localStorage.getItem(SHKEY) || "[]");
    if (!trips.length) return sharedTripsList.innerHTML = "<p>No saved trips.</p>";

    let html = `<h3>üìã Saved Trips</h3><table><tr>
      <th>ID</th><th>Date</th><th>Pickup</th><th>Drop</th>
      <th>Customer</th><th>Driver</th><th>Vehicle</th>
      <th>Amount</th><th>Status</th></tr>`;

    trips.forEach(t => {
      html += `<tr><td>${t.id}</td><td>${t.date}</td><td>${t.pickup}</td><td>${t.drop}</td>
        <td>${t.custName}</td><td>${t.driverName}</td><td>${t.vehicleModel}</td>
        <td>‚Çπ${t.totalAmount}</td><td>${t.paymentStatus}</td></tr>`;
    });
    sharedTripsList.innerHTML = html + "</table>";
  }

  tripDate.addEventListener("change", () => {
    const raw = tripDate.value;
    const d = new Date(raw);
    tripDateDisplay.value = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });
    tripDateDisplay.dataset.raw = raw;
  });

  window.onload = init;
</script>

</body>
</html>