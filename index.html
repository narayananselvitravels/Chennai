<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f4f6f9; padding: 20px; max-width: 900px; margin: auto; }
    h2 { color: #4b2aad }
    label { font-weight: 600; margin-top: 10px; display: block }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin: 5px 0 15px;
      border: 1px solid #ccc; border-radius: 5px; font-size: 15px;
    }
    button { background: #4b2aad; color: #fff; border: none; cursor: pointer }
    button:hover { background: #3a208b }
    .status-paid { background: #d4edda; color: #155724; font-weight: bold; }
    .status-unpaid { background: #f8d7da; color: #721c24; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background-color: #4b2aad; color: white; }
  </style>
</head>
<body>

<h2>üìù NST Trip Sheet</h2>

<!-- Trip ID and Date -->
<label>Trip ID</label>
<input id="tripId" readonly />

<label>Date</label>
<div style="position:relative">
  <input type="text" id="tripDateDisplay" placeholder="Select Date" readonly style="cursor:pointer" />
  <input type="date" id="tripDate" style="opacity:0;position:absolute;top:0;left:0;width:100%;height:100%;" />
</div>

<!-- Duty Column -->
<label>Duty</label>
<select id="dutySelect">
  <option value="">-- Select Duty --</option>
</select>

<!-- Locations -->
<label>Pickup Location</label><input id="pickupLocation" />
<label>Drop Location</label><input id="dropLocation" />

<!-- Customer -->
<label>Customer Name</label><input id="custName" />
<label>Customer Number</label><input id="custNumber" />

<!-- Driver -->
<label>Driver Name</label><select id="driverName" onchange="syncDriver(true)"></select>
<label>Driver Number</label><select id="driverNumber" onchange="syncDriver(false)"></select>

<!-- Vehicle -->
<label>Vehicle Model</label><select id="vehicleModel" onchange="syncVehicle(true)"></select>
<label>Vehicle Number</label><select id="vehicleNo" onchange="syncVehicle(false)"></select>

<!-- Time -->
<label>Start Time</label><input type="time" id="startTime" onchange="recalc()" />
<label>End Time</label><input type="time" id="endTime" onchange="recalc()" />
<label>Duration (hrs)</label><input id="duration" readonly />
<label>Extra Hours</label><input type="number" id="extraHours" />

<!-- KM -->
<label>Start KM</label><input type="number" id="startKM" onchange="recalc()" />
<label>End KM</label><input type="number" id="endKM" onchange="recalc()" />
<label>Total KM</label><input id="totalKM" readonly />
<label>Extra KM</label><input type="number" id="extraKM" />

<!-- Fare -->
<label>Parking ‚Çπ</label><input type="number" id="parking" />
<label>Toll ‚Çπ</label><input type="number" id="toll" />
<label>Total Amount ‚Çπ</label><input type="number" id="totalAmount" />

<!-- Payment -->
<label>Payment Status</label>
<select id="paymentStatus">
  <option value="">-- Select --</option>
  <option>Paid</option>
  <option>Not Paid</option>
</select>

<!-- Notes -->
<label>Note</label><textarea id="note" rows="3"></textarea>

<!-- Buttons -->
<button onclick="shareWhatsApp()">üì§ Share via WhatsApp</button>
<button onclick="showSharedTrips()">üìã View Saved Trips</button>
<button onclick="window.location.href='admin.html'">üîê Admin Panel</button>

<div id="sharedTripsList"></div>

<script>
  let drivers = {}, vehicles = {}, SHKEY = "shared-trips";

  function init() {
    // Trip ID
    tripId.value = genId();

    // Driver Master
    const dList = JSON.parse(localStorage.getItem("driver-master") || "[]");
    driverName.innerHTML = '<option value="">-- Select --</option>';
    driverNumber.innerHTML = '<option value="">-- Select --</option>';
    dList.forEach(d => {
      drivers[d.name] = d.mobile;
      driverName.innerHTML += `<option>${d.name}</option>`;
      driverNumber.innerHTML += `<option>${d.mobile}</option>`;
    });

    // Vehicle Master
    const vList = JSON.parse(localStorage.getItem("vehicle-master") || "[]");
    vehicleModel.innerHTML = '<option value="">-- Select --</option>';
    vehicleNo.innerHTML = '<option value="">-- Select --</option>';
    vList.forEach(v => {
      vehicles[v.model] = v.number;
      vehicleModel.innerHTML += `<option>${v.model}</option>`;
      vehicleNo.innerHTML += `<option>${v.number}</option>`;
    });

    // Duty Master
    const dutyList = JSON.parse(localStorage.getItem("duty-master") || "[]");
    dutySelect.innerHTML = '<option value="">-- Select Duty --</option>';
    dutyList.forEach(d => {
      if (typeof d === "string") {
        dutySelect.innerHTML += `<option>${d}</option>`;
      } else if (typeof d === "object" && d.name) {
        dutySelect.innerHTML += `<option>${d.name}</option>`;
      }
    });
  }

  function genId() {
    let n = parseInt(localStorage.getItem("trip-seq") || "1");
    return "#NST" + String(n).padStart(3, "0");
  }

  function reserveId() {
    let n = parseInt(localStorage.getItem("trip-seq") || "1");
    localStorage.setItem("#NST" + String(n).padStart(3, "0"), "used");
    localStorage.setItem("trip-seq", n + 1);
  }

  function syncDriver(fromName) {
    if (fromName) driverNumber.value = drivers[driverName.value] || "";
    else for (let k in drivers) if (drivers[k] === driverNumber.value) driverName.value = k;
  }

  function syncVehicle(fromModel) {
    if (fromModel) vehicleNo.value = vehicles[vehicleModel.value] || "";
    else for (let k in vehicles) if (vehicles[k] === vehicleNo.value) vehicleModel.value = k;
  }

  function recalc() {
    if (startTime.value && endTime.value) {
      let s = new Date(`1970-01-01T${startTime.value}`);
      let e = new Date(`1970-01-01T${endTime.value}`);
      let diff = (e - s) / (1000 * 60 * 60); // in hours
      if (diff < 0) diff += 24;
      duration.value = diff.toFixed(2);
    }
    if (startKM.value && endKM.value) {
      totalKM.value = endKM.value - startKM.value;
    }
  }

function shareWhatsApp() {
  const fields = {
    "üìã *NST TRIP SUMMARY*": "",

    "üóìÔ∏è *TRIP DETAILS*": {
      "‚Ä¢ *Trip ID:*": tripId.value,
      "‚Ä¢ *Date:*": tripDateDisplay.value
    },

    "üìç *LOCATIONS*": {
      "‚Ä¢ *Pickup:*": pickupLocation.value,
      "‚Ä¢ *Drop:*": dropLocation.value
    },

    "üë§ *CUSTOMER INFO*": {
      "‚Ä¢ *Name:*": custName.value,
      "‚Ä¢ *Number:*": custNumber.value
    },

    "üë®‚Äç‚úàÔ∏è *DRIVER INFO*": {
      "‚Ä¢ *Name:*": driverName.value,
      "‚Ä¢ *Number:*": driverNumber.value
    },

    "üöò *VEHICLE INFO*": {
      "‚Ä¢ *Model:*": vehicleModel.value,
      "‚Ä¢ *Number:*": vehicleNo.value
    },

    "üïí *TIME DETAILS*": {
      "‚Ä¢ *Start Time:*": startTime.value,
      "‚Ä¢ *End Time:*": endTime.value,
      "‚Ä¢ *Duration:*": duration.value ? `${duration.value} hrs` : "",
      "‚Ä¢ *Extra Hours:*": extraHours.value
    },

    "üìè *DISTANCE DETAILS*": {
      "‚Ä¢ *Start KM:*": startKM.value,
      "‚Ä¢ *End KM:*": endKM.value,
      "‚Ä¢ *Total KM:*": totalKM.value ? `${totalKM.value} km` : "",
      "‚Ä¢ *Extra KM:*": extraKM.value ? `${extraKM.value} km` : ""
    },

    "üí∞ *FARE DETAILS*": {
      "‚Ä¢ *Parking:*": parking?.value ? `‚Çπ${parking.value}` : "",
      "‚Ä¢ *Toll:*": toll?.value ? `‚Çπ${toll.value}` : "",
      "‚Ä¢ *Total Amount:*": totalAmount?.value ? `‚Çπ${totalAmount.value}` : "",
      "‚Ä¢ *Payment Status:*": paymentStatus.value
    },

    "üìù *NOTE*": note.value
  };

  let msg = "";

  for (const [section, data] of Object.entries(fields)) {
    if (typeof data === "string") {
      if (data.trim()) msg += `${section}\n${data.trim()}\n\n`;
      else if (section.includes("*NOTE*")) msg += `${section}\n-\n\n`;
      else msg += `${section}\n\n`;
    } else {
      let lines = Object.entries(data)
        .filter(([_, val]) => val && val.trim())
        .map(([label, val]) => `${label} ${val.trim()}`);
      if (lines.length) {
        msg += `${section}\n${lines.join("\n")}\n\n`;
      }
    }
  }

  window.open("https://wa.me/?text=" + encodeURIComponent(msg.trim()), "_blank");
  reserveId();
  tripId.value = genId();
}

  function showSharedTrips() {
    const arr = JSON.parse(localStorage.getItem(SHKEY) || "[]");
    if (!arr.length) return sharedTripsList.innerHTML = "<p>No trips saved.</p>";

    let html = `<h3>üìã Saved Trips</h3><table><tr>
    <th>ID</th><th>Date</th><th>Pickup</th><th>Drop</th>
    <th>Customer</th><th>Driver</th><th>Vehicle</th>
    <th>KM</th><th>Amount</th><th>Status</th></tr>`;

    arr.forEach(t => {
      const statusClass = t.paymentStatus === "Paid" ? "status-paid" : "status-unpaid";
      html += `<tr>
        <td>${t.id}</td><td>${t.date}</td><td>${t.pickup}</td><td>${t.drop}</td>
        <td>${t.custName}</td><td>${t.driverName}</td><td>${t.vehicleModel}</td>
        <td>${t.totalKM}</td><td>‚Çπ${t.totalAmount}</td>
        <td class="${statusClass}">${t.paymentStatus}</td>
      </tr>`;
    });

    sharedTripsList.innerHTML = html + "</table>";
  }

  // Date Formatting
  tripDate.addEventListener("change", () => {
    const raw = tripDate.value;
    const d = new Date(raw);
    tripDateDisplay.value = d.toLocaleDateString("en-GB", { day: '2-digit', month: 'long', year: 'numeric' });
    tripDateDisplay.dataset.raw = raw;
  });

  window.onload = init;
</script>

</body>
</html>