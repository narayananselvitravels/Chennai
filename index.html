<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f4f6f9; max-width: 1000px; margin: 20px auto; padding: 20px; }
    h2 { color: #4b2aad; }
    label { font-weight: 600; margin-top: 10px; display: block; }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin: 5px 0 15px;
      border: 1px solid #ccc; border-radius: 5px; font-size: 15px;
    }
    button {
      background: #4b2aad; color: white; border: none;
      padding: 10px 18px; border-radius: 5px; font-size: 16px; cursor: pointer;
      margin-right: 10px;
    }
    button:hover { background: #3a208b; }
    .paid { background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; }
    .notpaid { background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; font-size: 14px; text-align: left; }
    th { background: #4b2aad; color: white; }
  </style>
</head>
<body>

<h2>üìù NST Trip Entry</h2>

<label>Trip ID</label><input id="tripId" readonly>

<label>Date</label>
<div style="position:relative">
  <input type="text" id="tripDateDisplay" placeholder="Select Date" readonly style="cursor:pointer">
  <input type="date" id="tripDate" style="opacity:0; position:absolute; top:0; left:0; width:100%; height:100%;">
</div>

<label>Trip Category</label>
<select id="tripCategory" onchange="loadTripTypes()">
  <option value="">-- Select Category --</option>
  <option>Local</option>
  <option>Outstation</option>
  <option>Airport</option>
  <option>Pilgrimage</option>
  <option>Corporate</option>
  <option>Tour</option>
  <option>Wedding</option>
  <option>Emergency</option>
  <option>Shared</option>
  <option>School</option>
</select>

<label>Trip Type</label>
<select id="tripType"><option value="">-- Select Type --</option></select>

<label>Pickup Location</label><input id="pickupLocation">
<label>Drop Location</label><input id="dropLocation">

<label>Customer Name</label><input id="custName">
<label>Customer Number</label><input id="custNumber">

<label>Driver Name</label><select id="driverName" onchange="syncDriver(true)"></select>
<label>Driver Number</label><select id="driverNumber" onchange="syncDriver(false)"></select>

<label>Vehicle Model</label><select id="vehicleModel" onchange="syncVehicle(true)"></select>
<label>Vehicle Number</label><select id="vehicleNo" onchange="syncVehicle(false)"></select>

<label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
<label>End Time</label><input type="time" id="endTime" onchange="recalc()">
<label>Total Duration</label><input id="duration" readonly>

<label>Extra Hours</label><input type="number" id="extraHours">
<label>Start KM</label><input type="number" id="startKM" onchange="recalc()">
<label>End KM</label><input type="number" id="endKM" onchange="recalc()">
<label>Total KM</label><input id="totalKM" readonly>
<label>Extra KM</label><input type="number" id="extraKM">

<label>Total Amount ‚Çπ</label><input type="number" id="totalAmount">

<label>Payment Status</label>
<select id="paymentStatus">
  <option value="">-- Select --</option>
  <option>Paid</option>
  <option>Not Paid</option>
</select>

<label>Note</label><textarea id="note" rows="2"></textarea>

<!-- ACTION BUTTONS -->
<button onclick="shareWhatsApp()">üì§ Share via WhatsApp</button>
<button onclick="showSharedTrips()">üìã View Saved Trips</button>
<button onclick="window.location.href='admin.html'">üîê Admin Panel</button>

<div id="sharedTripsList"></div>

<script>
  const SHKEY = "shared-trips";
  let drivers = {}, vehicles = {};

  function init() {
    const dList = JSON.parse(localStorage.getItem("driver-master") || "[]");
    driverName.innerHTML = driverNumber.innerHTML = '<option value="">-- Select --</option>';
    dList.forEach(d => {
      drivers[d.name] = d.mobile;
      driverName.innerHTML += `<option>${d.name}</option>`;
      driverNumber.innerHTML += `<option>${d.mobile}</option>`;
    });

    const vList = JSON.parse(localStorage.getItem("vehicle-master") || "[]");
    vehicleModel.innerHTML = vehicleNo.innerHTML = '<option value="">-- Select --</option>';
    vList.forEach(v => {
      vehicles[v.model] = v.number;
      vehicleModel.innerHTML += `<option>${v.model}</option>`;
      vehicleNo.innerHTML += `<option>${v.number}</option>`;
    });

    tripId.value = genId();
  }

  function genId() {
    let n = parseInt(localStorage.getItem("trip-seq") || "1");
    return "#NST" + String(n).padStart(3, "0");
  }

  function reserveId() {
    let n = parseInt(localStorage.getItem("trip-seq") || "1");
    localStorage.setItem("trip-seq", n + 1);
  }

  function syncDriver(fromName) {
    if (fromName) driverNumber.value = drivers[driverName.value] || "";
    else for (let k in drivers) if (drivers[k] === driverNumber.value) driverName.value = k;
  }

  function syncVehicle(fromModel) {
    if (fromModel) vehicleNo.value = vehicles[vehicleModel.value] || "";
    else for (let k in vehicles) if (vehicles[k] === vehicleNo.value) vehicleModel.value = k;
  }

  function recalc() {
    if (startTime.value && endTime.value) {
      const s = new Date("1970-01-01T" + startTime.value);
      const e = new Date("1970-01-01T" + endTime.value);
      let diffMs = e - s;
      if (diffMs < 0) diffMs += 24 * 3600000;
      let hrs = Math.floor(diffMs / 3600000);
      let mins = Math.round((diffMs % 3600000) / 60000);
      duration.value = `${hrs} hrs ${mins} mins`;
    }

    if (startKM.value && endKM.value) {
      totalKM.value = parseFloat(endKM.value) - parseFloat(startKM.value);
    }
  }

  function shareWhatsApp() {
    const id = tripId.value;
    const msg = `üìã *TRIP SUMMARY*\n\n*Trip ID:* ${id}\n*Date:* ${tripDateDisplay.value}\n*Category:* ${tripCategory.value}\n*Type:* ${tripType.value}\n\n` +
    `üìç *Pickup:* ${pickupLocation.value}\nüìç *Drop:* ${dropLocation.value}\n\n` +
    `üë§ *Customer:* ${custName.value} (${custNumber.value})\n` +
    `üöñ *Driver:* ${driverName.value} (${driverNumber.value})\n` +
    `üöò *Vehicle:* ${vehicleModel.value} (${vehicleNo.value})\n\n` +
    `üïí *Time:* ${startTime.value} - ${endTime.value} (${duration.value})\n` +
    `üìç *KM:* ${startKM.value} - ${endKM.value} = ${totalKM.value} km (Extra ${extraKM.value} km)\n` +
    `üí∞ *Total Amount:* ‚Çπ${totalAmount.value} | *Status:* ${paymentStatus.value}\n\n` +
    `üìù *Note:* ${note.value || '-'}`;
    
    // Save Trip on WhatsApp Share
    const data = {
      id: id,
      date: tripDateDisplay.dataset.raw || "",
      category: tripCategory.value,
      type: tripType.value,
      pickup: pickupLocation.value,
      drop: dropLocation.value,
      custName: custName.value,
      custNumber: custNumber.value,
      driverName: driverName.value,
      driverNumber: driverNumber.value,
      vehicleModel: vehicleModel.value,
      vehicleNo: vehicleNo.value,
      start: startTime.value,
      end: endTime.value,
      duration: duration.value,
      extraHours: extraHours.value,
      startKM: startKM.value,
      endKM: endKM.value,
      totalKM: totalKM.value,
      extraKM: extraKM.value,
      totalAmount: totalAmount.value,
      paymentStatus: paymentStatus.value,
      note: note.value
    };
    let arr = JSON.parse(localStorage.getItem(SHKEY) || "[]");
    arr.push(data);
    localStorage.setItem(SHKEY, JSON.stringify(arr));
    reserveId();
    tripId.value = genId();
    
    window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank");
  }

  function showSharedTrips() {
    const trips = JSON.parse(localStorage.getItem(SHKEY) || "[]");
    if (!trips.length) return sharedTripsList.innerHTML = "<p>No saved trips yet.</p>";
    let html = `<h3>üìã Saved Trips</h3><table><tr>
    <th>ID</th><th>Date</th><th>Pickup</th><th>Drop</th><th>Category</th><th>Type</th><th>Customer</th>
    <th>Driver</th><th>Vehicle</th><th>Duration</th><th>KM</th><th>Amount</th><th>Status</th></tr>`;
    trips.forEach(t => {
      html += `<tr><td>${t.id}</td><td>${t.date}</td><td>${t.pickup}</td><td>${t.drop}</td><td>${t.category}</td><td>${t.type}</td>
      <td>${t.custName}</td><td>${t.driverName}</td><td>${t.vehicleModel}</td><td>${t.duration}</td>
      <td>${t.totalKM}</td><td>‚Çπ${t.totalAmount}</td><td><span class="${t.paymentStatus === 'Paid' ? 'paid' : 'notpaid'}">${t.paymentStatus}</span></td></tr>`;
    });
    sharedTripsList.innerHTML = html + "</table>";
  }

  function loadTripTypes() {
    const cat = tripCategory.value;
    let types = ['-- Select Type --'];
    if (cat === 'Local') types.push('Point-to-Point', 'Hourly Rental');
    else if (cat === 'Outstation') types.push('One Way', 'Round Trip', 'Multi-day');
    else if (cat === 'Airport') types.push('Pickup', 'Drop', 'Round Trip');
    else if (cat === 'Pilgrimage') types.push('Tirupati', 'Rameswaram', 'Kanchipuram');
    else if (cat === 'Corporate') types.push('Employee Drop', 'Guest Transfer', 'Full Day');
    else if (cat === 'Tour') types.push('City Tour', 'Multi-location');
    else if (cat === 'Wedding') types.push('Bride/Groom Car', 'Guest Transport');
    else if (cat === 'Emergency') types.push('Medical', 'Late Night');
    else if (cat === 'Shared') types.push('Shared Ride', 'Seat Booking');
    else if (cat === 'School') types.push('Daily Pickup/Drop');

    tripType.innerHTML = types.map(t => `<option>${t}</option>`).join('');
  }

  tripDate.addEventListener("change", () => {
    const raw = tripDate.value;
    const d = new Date(raw);
    tripDateDisplay.value = d.toLocaleDateString("en-GB", { day: "2-digit", month: "long", year: "numeric" });
    tripDateDisplay.dataset.raw = raw;
  });

  window.onload = init;
</script>

</body>
</html>