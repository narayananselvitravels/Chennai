<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f4f6f9; padding: 20px; max-width: 900px; margin: auto; }
    h2 { color: #4b2aad }
    label { font-weight: 600; margin-top: 10px; display: block }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin: 5px 0 15px;
      border: 1px solid #ccc; border-radius: 5px; font-size: 15px;
    }
    button { background: #4b2aad; color: #fff; border: none; cursor: pointer }
    button:hover { background: #3a208b }
    .status-paid { background: #d4edda; color: #155724; font-weight: bold; }
    .status-unpaid { background: #f8d7da; color: #721c24; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background-color: #4b2aad; color: white; }
  </style>
</head>
<body>

<h2>üìù NST Trip Sheet</h2>

<label>Trip ID</label><input id="tripId" readonly />
<label>Date</label>
<div style="position:relative">
  <input type="text" id="tripDateDisplay" placeholder="Select Date" readonly style="cursor:pointer" />
  <input type="date" id="tripDate" style="opacity:0;position:absolute;top:0;left:0;width:100%;height:100%;" />
</div>
<label>Duty</label><select id="dutySelect"><option value="">-- Select Duty --</option></select>
<label>Pickup Location</label><input id="pickupLocation" />
<label>Drop Location</label><input id="dropLocation" />
<label>Customer Name</label><input id="custName" />
<label>Customer Number</label><input id="custNumber" />
<label>Driver Name</label><select id="driverName" onchange="syncDriver(true)"></select>
<label>Driver Number</label><select id="driverNumber" onchange="syncDriver(false)"></select>
<label>Vehicle Model</label><select id="vehicleModel" onchange="syncVehicle(true)"></select>
<label>Vehicle Number</label><select id="vehicleNo" onchange="syncVehicle(false)"></select>
<label>Start Time</label><input type="time" id="startTime" onchange="recalc()" />
<label>End Time</label><input type="time" id="endTime" onchange="recalc()" />
<label>Duration (hrs)</label><input id="duration" readonly />
<label>Extra Hours</label><input type="number" id="extraHours" />
<label>Start KM</label><input type="number" id="startKM" onchange="recalc()" />
<label>End KM</label><input type="number" id="endKM" onchange="recalc()" />
<label>Total KM</label><input id="totalKM" readonly />
<label>Extra KM</label><input type="number" id="extraKM" />
<label>Parking ‚Çπ</label><input type="number" id="parking" />
<label>Toll ‚Çπ</label><input type="number" id="toll" />
<label>Total Amount ‚Çπ</label><input type="number" id="totalAmount" />
<label>Payment Status</label>
<select id="paymentStatus">
  <option value="">-- Select --</option>
  <option>Paid</option>
  <option>Not Paid</option>
</select>
<label>Note</label><textarea id="note" rows="3"></textarea>

<button onclick="shareWhatsApp()">üì§ Share via WhatsApp</button>
<button onclick="saveTripToFirebase()">üíæ Save to Firebase</button>
<button onclick="showSharedTrips()">üìã View Saved Trips</button>
<button onclick="window.location.href='admin.html'">üîê Admin Panel</button>

<div id="sharedTripsList"></div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyApXtRsd8S2u9tXseS9DSBUGVTEBZlw-mM",
    authDomain: "nst-travels-457ae.firebaseapp.com",
    databaseURL: "https://nst-travels-457ae-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "nst-travels-457ae",
    storageBucket: "nst-travels-457ae.appspot.com",
    messagingSenderId: "17843202269",
    appId: "1:17843202269:web:9f9a785291d9a7b13c5334"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  window.saveTripToFirebase = function () {
    const data = collectTripData();
    const tripsRef = ref(db, "trips");
    const newTrip = push(tripsRef);
    set(newTrip, data).then(() => {
      alert("‚úÖ Trip saved!");
      reserveId();
      tripId.value = genId();
    });
  };

  window.shareWhatsApp = function () {
    const data = collectTripData();
    const tripsRef = ref(db, "trips");

    onValue(tripsRef, (snapshot) => {
      const trips = snapshot.val();
      let exists = false;
      if (trips) {
        for (const key in trips) {
          if (trips[key].id === data.id) {
            exists = true;
            break;
          }
        }
      }

      if (!exists) {
        const newTrip = push(tripsRef);
        set(newTrip, data)
          .then(() => console.log("‚úÖ Trip saved during WhatsApp share"));
      } else {
        console.log("‚ö†Ô∏è Duplicate trip, skipping save");
      }

      sendWhatsAppMessage(data);
      reserveId();
      tripId.value = genId();
    }, { onlyOnce: true });
  };

  function collectTripData() {
    return {
      id: tripId.value,
      date: tripDateDisplay.value,
      pickup: pickupLocation.value,
      drop: dropLocation.value,
      custName: custName.value,
      custNumber: custNumber.value,
      driverName: driverName.value,
      driverNumber: driverNumber.value,
      vehicleModel: vehicleModel.value,
      vehicleNo: vehicleNo.value,
      startTime: startTime.value,
      endTime: endTime.value,
      duration: duration.value,
      extraHours: extraHours.value,
      startKM: startKM.value,
      endKM: endKM.value,
      totalKM: totalKM.value,
      extraKM: extraKM.value,
      parking: parking.value,
      toll: toll.value,
      totalAmount: totalAmount.value,
      paymentStatus: paymentStatus.value,
      note: note.value,
      timestamp: Date.now()
    };
  }

  function sendWhatsAppMessage(data) {
    const msg = `
üìã *NST TRIP SUMMARY*

üóì *Trip ID:* ${data.id}
üìç *Date:* ${data.date}
üë§ *Customer:* ${data.custName} (${data.custNumber})
üßç *Driver:* ${data.driverName} (${data.driverNumber})
üöò *Vehicle:* ${data.vehicleModel} (${data.vehicleNo})
üìç *From:* ${data.pickup} ‚û°Ô∏è *To:* ${data.drop}
üïí *Time:* ${data.startTime}‚Äì${data.endTime} (${data.duration} hrs)
üìè *KM:* ${data.startKM} ‚Üí ${data.endKM} = ${data.totalKM} km (+${data.extraKM} km)
üí∞ *Amount:* ‚Çπ${data.totalAmount} (Toll ‚Çπ${data.toll}, Parking ‚Çπ${data.parking})
üí≥ *Payment:* ${data.paymentStatus}
üìù *Note:* ${data.note || "-"}
`.trim();

    window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank");
  }

  window.showSharedTrips = function () {
    const tripsRef = ref(db, "trips");
    onValue(tripsRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) return sharedTripsList.innerHTML = "<p>No trips found.</p>";

      let html = `<h3>üìã Trips</h3><table><tr>
        <th>ID</th><th>Date</th><th>Pickup</th><th>Drop</th>
        <th>Driver</th><th>Vehicle</th><th>KM</th><th>‚Çπ</th><th>Status</th><th>‚ùå</th></tr>`;

      Object.entries(data).forEach(([key, t]) => {
        const statusClass = t.paymentStatus === "Paid" ? "status-paid" : "status-unpaid";
        html += `<tr>
          <td>${t.id}</td><td>${t.date}</td><td>${t.pickup}</td><td>${t.drop}</td>
          <td>${t.driverName}</td><td>${t.vehicleModel}</td><td>${t.totalKM}</td>
          <td>‚Çπ${t.totalAmount}</td><td class="${statusClass}">${t.paymentStatus}</td>
          <td><button onclick="deleteTrip('${key}', '${t.id}')">üóëÔ∏è</button></td>
        </tr>`;
      });

      sharedTripsList.innerHTML = html + "</table>";
    });
  };

  window.deleteTrip = function (key, id) {
    if (confirm("Delete trip " + id + "?")) {
      remove(ref(db, "trips/" + key)).then(() => alert("üóëÔ∏è Trip deleted"));
    }
  };

  tripDate.addEventListener("change", () => {
    const d = new Date(tripDate.value);
    tripDateDisplay.value = d.toLocaleDateString("en-GB", { day: '2-digit', month: 'long', year: 'numeric' });
  });

  window.onload = () => {
    tripId.value = genId();
    const dList = JSON.parse(localStorage.getItem("driver-master") || "[]");
    dList.forEach(d => {
      driverName.innerHTML += `<option>${d.name}</option>`;
      driverNumber.innerHTML += `<option>${d.mobile}</option>`;
    });
    const vList = JSON.parse(localStorage.getItem("vehicle-master") || "[]");
    vList.forEach(v => {
      vehicleModel.innerHTML += `<option>${v.model}</option>`;
      vehicleNo.innerHTML += `<option>${v.number}</option>`;
    });
    const dutyList = JSON.parse(localStorage.getItem("duty-master") || "[]");
    dutyList.forEach(d => {
      const name = typeof d === "string" ? d : d.name;
      if (name) dutySelect.innerHTML += `<option>${name}</option>`;
    });
  };

  function genId() {
    let n = parseInt(localStorage.getItem("trip-seq") || "1");
    return "#NST" + String(n).padStart(3, "0");
  }

  function reserveId() {
    let n = parseInt(localStorage.getItem("trip-seq") || "1");
    localStorage.setItem("#NST" + String(n).padStart(3, "0"), "used");
    localStorage.setItem("trip-seq", n + 1);
  }

  function recalc() {
    if (startTime.value && endTime.value) {
      let s = new Date("1970-01-01T" + startTime.value);
      let e = new Date("1970-01-01T" + endTime.value);
      let diff = (e - s) / (1000 * 60 * 60);
      if (diff < 0) diff += 24;
      duration.value = diff.toFixed(2);
    }
    if (startKM.value && endKM.value) {
      totalKM.value = endKM.value - startKM.value;
    }
  }

  function syncDriver(fromName) {
    const drivers = JSON.parse(localStorage.getItem("driver-master") || "[]");
    if (fromName) {
      const d = drivers.find(d => d.name === driverName.value);
      driverNumber.value = d ? d.mobile : "";
    } else {
      const d = drivers.find(d => d.mobile === driverNumber.value);
      driverName.value = d ? d.name : "";
    }
  }

  function syncVehicle(fromModel) {
    const vehicles = JSON.parse(localStorage.getItem("vehicle-master") || "[]");
    if (fromModel) {
      const v = vehicles.find(v => v.model === vehicleModel.value);
      vehicleNo.value = v ? v.number : "";
    } else {
      const v = vehicles.find(v => v.number === vehicleNo.value);
      vehicleModel.value = v ? v.model : "";
    }
  }
</script>

</body>
</html>
