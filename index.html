<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f4f6f9; padding: 20px; max-width: 900px; margin: auto; }
    h2 { color: #4b2aad }
    label { font-weight: 600; margin-top: 10px; display: block }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin: 5px 0 15px;
      border: 1px solid #ccc; border-radius: 5px; font-size: 15px;
    }
    button { background: #4b2aad; color: #fff; border: none; cursor: pointer }
    button:hover { background: #3a208b }
    .status-paid { background: #d4edda; color: #155724; font-weight: bold; }
    .status-unpaid { background: #f8d7da; color: #721c24; font-weight: bold; }
  </style>
</head>
<body>
<h2>📝 NST Trip Sheet</h2>

<label>Trip ID</label><input id="tripId" readonly />

<label>Date</label>
<div style="position:relative">
  <input type="text" id="tripDateDisplay" placeholder="Select Date" readonly style="cursor:pointer" />
  <input type="date" id="tripDate" style="opacity:0;position:absolute;top:0;left:0;width:100%;height:100%;" />
</div>

<label>Pickup Location</label><input id="pickupLocation" />
<label>Drop Location</label><input id="dropLocation" />
<label>Customer Name</label><input id="custName" />
<label>Customer Number</label><input id="custNumber" />
<label>Driver Name</label><input id="driverName" />
<label>Driver Number</label><input id="driverNumber" />
<label>Vehicle Model</label><input id="vehicleModel" />
<label>Vehicle Number</label><input id="vehicleNo" />
<label>Start Time</label><input type="time" id="startTime" />
<label>End Time</label><input type="time" id="endTime" />
<label>Start KM</label><input type="number" id="startKM" />
<label>End KM</label><input type="number" id="endKM" />
<label>Total Amount ₹</label><input type="number" id="totalAmount" />
<label>Payment Status</label>
<select id="paymentStatus">
  <option value="">-- Select --</option>
  <option>Paid</option>
  <option>Not Paid</option>
</select>
<label>Note</label><textarea id="note" rows="3"></textarea>

<button onclick="shareWhatsApp()">📤 Share via WhatsApp</button>
<button onclick="saveTripToFirebase()">💾 Save to Firebase</button>
<button onclick="window.location.href='admin.html'">🔐 Admin Panel</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, get, set, runTransaction } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyApXtRsd8S2u9tXseS9DSBUGVTEBZlw-mM",
    authDomain: "nst-travels-457ae.firebaseapp.com",
    databaseURL: "https://nst-travels-457ae-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "nst-travels-457ae",
    storageBucket: "nst-travels-457ae.appspot.com",
    messagingSenderId: "17843202269",
    appId: "1:17843202269:web:9f9a785291d9a7b13c5334"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let currentTripId = "";

  async function getTripIdPreview() {
    const snapshot = await get(ref(db, "trip-seq"));
    const seq = snapshot.exists() ? snapshot.val() : 1;
    currentTripId = "#NST" + String(seq).padStart(3, "0");
    document.getElementById("tripId").value = currentTripId;
  }

  async function generateTripIdAndReserve() {
    const seqRef = ref(db, "trip-seq");
    const result = await runTransaction(seqRef, current => (current || 1) + 1);
    const tripId = "#NST" + String(result.snapshot.val() - 1).padStart(3, "0");
    currentTripId = tripId;
    document.getElementById("tripId").value = tripId;
    return tripId;
  }

  function getTripData() {
    return {
      id: currentTripId,
      date: tripDateDisplay.value,
      pickup: pickupLocation.value,
      drop: dropLocation.value,
      custName: custName.value,
      custNumber: custNumber.value,
      driverName: driverName.value,
      driverNumber: driverNumber.value,
      vehicleModel: vehicleModel.value,
      vehicleNo: vehicleNo.value,
      startTime: startTime.value,
      endTime: endTime.value,
      startKM: startKM.value,
      endKM: endKM.value,
      totalAmount: totalAmount.value,
      paymentStatus: paymentStatus.value,
      note: note.value
    };
  }

  async function saveTripToFirebase() {
    if (!currentTripId) return alert("Trip ID not set.");
    const tripRef = ref(db, "trips/" + currentTripId);
    const snapshot = await get(tripRef);
    if (snapshot.exists()) {
      alert("Trip already exists in Firebase.");
      return;
    }
    await set(tripRef, getTripData());
    alert("Trip saved to Firebase.");
    await generateTripIdAndReserve(); // increment only on save
  }

  async function shareWhatsApp() {
    if (!currentTripId) await generateTripIdAndReserve();
    const trip = getTripData();
    const msg = `📋 NST TRIP SUMMARY

🗓 Date: ${trip.date}
📍 From: ${trip.pickup} → ${trip.drop}
👤 Customer: ${trip.custName} (${trip.custNumber})
👨‍✈ Driver: ${trip.driverName} (${trip.driverNumber})
🚘 Vehicle: ${trip.vehicleModel} (${trip.vehicleNo})
🕒 Time: ${trip.startTime} - ${trip.endTime}
📏 KM: ${trip.startKM} → ${trip.endKM}
💰 Amount: ₹${trip.totalAmount}
💳 Payment: ${trip.paymentStatus}
📝 Note: ${trip.note}

Trip ID: ${trip.id}`;

    const tripRef = ref(db, "trips/" + trip.id);
    const snapshot = await get(tripRef);
    if (!snapshot.exists()) {
      await set(tripRef, trip);
    }

    window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank");
    await generateTripIdAndReserve(); // increment only after successful share
  }

  tripDate.addEventListener("change", () => {
    const d = new Date(tripDate.value);
    tripDateDisplay.value = d.toLocaleDateString("en-GB", { day: '2-digit', month: 'long', year: 'numeric' });
  });

  window.onload = getTripIdPreview;
</script>

</body>
</html>
