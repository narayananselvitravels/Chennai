<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <!-- Toastr for notifications -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <!-- Chart.js for analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse for CSV import/export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    /* ... Keep your existing styles ... */
    /* Add extra for toasts, charts, etc as needed */
    #dashboard { margin-top: 40px; }
    #chartContainer { width:100%; max-width:600px; margin:auto;}
  </style>
</head>
<body>

<!-- Authentication UI -->
<div id="authSection">
  <button onclick="login()">Login</button>
  <button onclick="logout()">Logout</button>
  <span id="currentUser"></span>
</div>

<h2>📝 NST Trip Sheet</h2>

<!-- Export/Import Buttons -->
<button onclick="exportTrips()">⬇️ Export Trips (CSV)</button>
<input type="file" id="importFile" accept=".csv" style="display:none" onchange="importTrips(event)">
<button onclick="document.getElementById('importFile').click()">⬆️ Import Trips (CSV)</button>

<!-- Search/Filter UI -->
<div>
  <input id="searchInput" placeholder="Search by Driver, Duty, or Location" oninput="filterTrips()">
  <select id="filterStatus" onchange="filterTrips()">
    <option value="">All Status</option>
    <option value="Paid">Paid</option>
    <option value="Not Paid">Not Paid</option>
  </select>
</div>

<!-- Trip Form (existing form) -->
<!-- ... Keep your trip form as is ... -->

<!-- WhatsApp recipient selection -->
<label>Share with:</label>
<select id="whatsappRecipient">
  <option value="customer">Customer</option>
  <option value="driver">Driver</option>
</select>

<button onclick="shareWhatsApp()">📤 Share via WhatsApp</button>
<button onclick="showSharedTrips()">📋 View Saved Trips</button>
<button onclick="window.location.href='admin.html'">🔐 Admin Panel</button>

<div id="sharedTripsList"></div>

<!-- Analytics Dashboard -->
<div id="dashboard">
  <h3>📊 Analytics Dashboard</h3>
  <div id="summaryStats"></div>
  <div id="chartContainer">
    <canvas id="tripsChart"></canvas>
  </div>
</div>

<!-- Toastr notifications -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script type="module">
  import { supabase } from './supabase.js';

  // --- 2. Authentication & Roles ---
  let currentUser = null;
  async function login() {
    // Simple Supabase login (replace with your flow)
    const { user, error } = await supabase.auth.signInWithOAuth({ provider: 'google' });
    if(user) {
      currentUser = user;
      document.getElementById('currentUser').textContent = `Logged in as ${user.email}`;
    } else if(error) {
      toastr.error("Login failed.");
    }
  }
  async function logout() {
    await supabase.auth.signOut();
    currentUser = null;
    document.getElementById('currentUser').textContent = '';
    toastr.info("Logged out.");
  }

  // --- 3. Cloud Sync ---
  async function saveTripCloud(trip) {
    if(!currentUser) return toastr.warning("Login required for cloud sync.");
    const { data, error } = await supabase.from('trips').insert([trip]);
    if(error) toastr.error("Cloud save failed.");
    else toastr.success("Trip saved to cloud!");
  }

  // --- 1. Export/Import Trips ---
  function exportTrips() {
    const trips = JSON.parse(localStorage.getItem("shared-trips") || "[]");
    const csv = Papa.unparse(trips);
    const blob = new Blob([csv], {type: "text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = "NST_trips.csv";
    a.click();
    toastr.success("Trips exported!");
  }
  function importTrips(event) {
    const file = event.target.files[0];
    Papa.parse(file, {
      header: true,
      complete: function(results) {
        localStorage.setItem("shared-trips", JSON.stringify(results.data));
        toastr.success("Trips imported!");
        showSharedTrips();
      }
    });
  }

  // --- 4. Edit/Delete Trips ---
  function editTrip(idx) {
    // Load trip data into form for editing
    const trips = JSON.parse(localStorage.getItem("shared-trips") || "[]");
    const t = trips[idx];
    // Fill form fields as needed...
    // Set a flag so saveTrip knows it's editing
    window.editingTripIdx = idx;
  }
  function deleteTrip(idx) {
    let trips = JSON.parse(localStorage.getItem("shared-trips") || "[]");
    trips.splice(idx, 1);
    localStorage.setItem("shared-trips", JSON.stringify(trips));
    toastr.info("Trip deleted.");
    showSharedTrips();
  }

  // --- 5. Search & Filter ---
  function filterTrips() {
    const search = searchInput.value.toLowerCase();
    const status = filterStatus.value;
    let trips = JSON.parse(localStorage.getItem("shared-trips") || "[]");
    const filtered = trips.filter(t =>
      (!search || (t.driverName + t.duty + t.pickup + t.drop).toLowerCase().includes(search)) &&
      (!status || t.paymentStatus === status)
    );
    renderTripsTable(filtered);
  }

  // --- 6. Reminders & Notifications ---
  function checkReminders() {
    const trips = JSON.parse(localStorage.getItem("shared-trips") || "[]");
    const today = new Date();
    trips.forEach(t => {
      if(t.paymentStatus === "Not Paid") toastr.warning(`Unpaid trip: ${t.id}`);
      // Upcoming trip logic
      let d = new Date(t.date);
      if((d - today) < 86400000 && (d - today) > 0) toastr.info(`Trip tomorrow: ${t.id}`);
    });
  }

  // --- 7. PWA Manifest/Service Worker ---
  // Add a manifest.json and simple service worker registration here for installability:
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(() => {
      console.log('Service Worker registered');
    });
  }

  // --- 8. Advanced WhatsApp Sharing ---
  function shareWhatsApp() {
    let recipient = whatsappRecipient.value;
    let number = recipient === "customer" ? custNumber.value : driverNumber.value;
    // ... build the message as before ...
    let msg = "NST Trip Details ..."; // Build full message here
    window.open(`https://wa.me/${number}?text=${encodeURIComponent(msg)}`, '_blank');
    toastr.info(`Shared with ${recipient}.`);
  }

  // --- 9. Analytics Dashboard ---
  function updateDashboard() {
    const trips = JSON.parse(localStorage.getItem("shared-trips") || "[]");
    let totalTrips = trips.length;
    let paid = trips.filter(t => t.paymentStatus === "Paid").length;
    let unpaid = totalTrips - paid;
    let totalRevenue = trips.reduce((sum, t) => sum + Number(t.totalAmount||0), 0);

    summaryStats.innerHTML = `
      <p>Total Trips: <b>${totalTrips}</b></p>
      <p>Total Revenue: <b>₹${totalRevenue}</b></p>
      <p>Paid: <b>${paid}</b> | Unpaid: <b>${unpaid}</b></p>
    `;

    // Chart: Trips per Driver
    let driverCounts = {};
    trips.forEach(t => { driverCounts[t.driverName] = (driverCounts[t.driverName]||0)+1; });
    new Chart(document.getElementById('tripsChart'), {
      type: 'bar',
      data: {
        labels: Object.keys(driverCounts),
        datasets: [{ label: "Trips per Driver", data: Object.values(driverCounts) }]
      }
    });
  }

  // --- 10. UI/UX Improvements ---
  function validateForm() {
    if(!duty.value) { toastr.error("Duty required."); return false; }
    if(!custName.value) { toastr.error("Customer name required."); return false; }
    // ...other validations...
    return true;
  }

  // --- Existing showSharedTrips, saveTrip, etc. ---
  function showSharedTrips() {
    let trips = JSON.parse(localStorage.getItem("shared-trips") || "[]");
    if (!trips.length) return sharedTripsList.innerHTML = "<p>No trips saved.</p>";
    let html = `<h3>📋 Saved Trips</h3><table><tr>
    <th>ID</th><th>Date</th><th>Duty</th><th>Pickup</th><th>Drop</th><th>Driver</th><th>Vehicle</th><th>Amount</th><th>Status</th><th>Edit</th><th>Delete</th></tr>`;
    trips.forEach((t, idx) => {
      html += `<tr>
      <td>${t.id}</td><td>${t.date}</td><td>${t.duty}</td><td>${t.pickup}</td><td>${t.drop}</td>
      <td>${t.driverName}</td><td>${t.vehicleModel}</td><td>₹${t.totalAmount}</td>
      <td>${t.paymentStatus}</td>
      <td><button onclick="editTrip(${idx})">Edit</button></td>
      <td><button onclick="deleteTrip(${idx})">Delete</button></td>
      </tr>`;
    });
    sharedTripsList.innerHTML = html + "</table>";
    updateDashboard();
  }

  // Call reminders and dashboard on load
  window.onload = function() {
    checkReminders();
    showSharedTrips();
  };

</script>
</body>
</html>
