<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>All Trips ‚Äì NST</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f4f6f9; padding: 20px; max-width: 1200px; margin: auto; }
    h2 { color: #4b2aad; }
    input, button, select {
      padding: 10px; font-size: 16px; margin-bottom: 15px;
      border-radius: 5px; border: 1px solid #ccc;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td {
      border: 1px solid #ddd; padding: 8px; text-align: left;
    }
    th {
      background: #4b2aad; color: white; cursor: pointer;
    }
    .btn {
      background: #4b2aad; color: white; border: none;
      padding: 10px 16px; cursor: pointer; border-radius: 5px; margin-right: 5px;
    }
    .btn:hover { background: #3a208b; }
    .danger { background: #dc3545; }
    .danger:hover { background: #b02a37; }
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 10px; width: 500px;
      max-height: 90vh; overflow-y: auto;
    }
  </style>
</head>
<body>

<h2>üìã All Trips ‚Äì NST</h2>

<input type="text" id="searchBox" placeholder="üîç Search trip, driver, vehicle, etc." onkeyup="filterTable()">
<button class="btn" onclick="exportTrips()">üì• Export to Excel</button>

<div id="tripTableContainer"></div>

<!-- üõ†Ô∏è Modal for Edit -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h3>Edit Trip</h3>
    <input id="editDate" placeholder="Date (DD-MM-YYYY)">
    <input id="editPickup" placeholder="Pickup Location">
    <input id="editDrop" placeholder="Drop Location">
    <input id="editCustName" placeholder="Customer Name">
    <input id="editCustNumber" placeholder="Customer Number">
    <input id="editDriver" placeholder="Driver Name">
    <input id="editVehicle" placeholder="Vehicle Model">
    <input id="editTotalKM" placeholder="Total KM">
    <input id="editAmount" placeholder="Total Amount">
    <select id="editStatus">
      <option value="">-- Status --</option>
      <option>Paid</option>
      <option>Not Paid</option>
    </select>
    <input type="hidden" id="editIndex">
    <button class="btn" onclick="saveEdit()">üíæ Save Changes</button>
    <button class="btn danger" onclick="closeModal()">‚úñ Close</button>
  </div>
</div>

<script>
const STORAGE_KEY = "shared-trips";

function loadTrips() {
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  if (!data.length) {
    tripTableContainer.innerHTML = "<p>No trips available.</p>";
    return;
  }

  let html = `<table id="tripTable">
    <thead><tr>
      <th onclick="sortTable(0)">Trip ID</th>
      <th>Date</th>
      <th>Pickup</th>
      <th>Drop</th>
      <th>Driver</th>
      <th>Vehicle</th>
      <th>KM</th>
      <th>Amount</th>
      <th>Status</th>
      <th>Action</th>
    </tr></thead><tbody>`;

  data.forEach((t, i) => {
    html += `<tr>
      <td>${t.id}</td>
      <td>${t.date}</td>
      <td>${t.pickup}</td>
      <td>${t.drop}</td>
      <td>${t.driverName}</td>
      <td>${t.vehicleModel}</td>
      <td>${t.totalKM} km</td>
      <td>‚Çπ${t.totalAmount}</td>
      <td>${t.paymentStatus}</td>
      <td>
        <button class="btn" onclick="editTrip(${i})">‚úè Edit</button>
        <button class="btn danger" onclick="deleteTrip(${i})">üóë Delete</button>
      </td>
    </tr>`;
  });

  html += "</tbody></table>";
  tripTableContainer.innerHTML = html;
}

function editTrip(index) {
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]")[index];
  editIndex.value = index;
  editDate.value = data.date || "";
  editPickup.value = data.pickup || "";
  editDrop.value = data.drop || "";
  editCustName.value = data.custName || "";
  editCustNumber.value = data.custNumber || "";
  editDriver.value = data.driverName || "";
  editVehicle.value = data.vehicleModel || "";
  editTotalKM.value = data.totalKM || "";
  editAmount.value = data.totalAmount || "";
  editStatus.value = data.paymentStatus || "";
  editModal.style.display = "flex";
}

function saveEdit() {
  const idx = parseInt(editIndex.value);
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  if (!data[idx]) return;

  data[idx].date = editDate.value;
  data[idx].pickup = editPickup.value;
  data[idx].drop = editDrop.value;
  data[idx].custName = editCustName.value;
  data[idx].custNumber = editCustNumber.value;
  data[idx].driverName = editDriver.value;
  data[idx].vehicleModel = editVehicle.value;
  data[idx].totalKM = editTotalKM.value;
  data[idx].totalAmount = editAmount.value;
  data[idx].paymentStatus = editStatus.value;

  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  closeModal();
  loadTrips();
}

function closeModal() {
  editModal.style.display = "none";
}

function deleteTrip(index) {
  if (!confirm("Delete this trip?")) return;
  let arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  arr.splice(index, 1);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  loadTrips();
}

function exportTrips() {
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  if (!data.length) return alert("No data to export.");

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "NST Trips");
  XLSX.writeFile(wb, "NST_Trips.xlsx");
}

function filterTable() {
  const val = searchBox.value.toLowerCase();
  const rows = document.querySelectorAll("#tripTable tbody tr");
  rows.forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(val) ? "" : "none";
  });
}

function sortTable(colIndex) {
  const table = document.getElementById("tripTable");
  const rows = Array.from(table.rows).slice(1);
  let asc = table.dataset.sort !== "asc";
  rows.sort((a, b) => a.cells[colIndex].innerText.localeCompare(b.cells[colIndex].innerText));
  if (!asc) rows.reverse();
  rows.forEach(r => table.tBodies[0].appendChild(r));
  table.dataset.sort = asc ? "asc" : "desc";
}

window.onload = loadTrips;
</script>

</body>
</html>
